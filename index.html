<!DOCTYPE html><html><head><meta charset="utf-8"><title>nBlocksStudio: Introduction.md</title><style></style></head><body id="preview">
<h1 class="code-line" data-line-start=0 data-line-end=1><a id="nBlocksStudio_Introduction_0"></a>nBlocksStudio: Introduction</h1>
<p class="has-line-data" data-line-start="1" data-line-end="3">The vast majority of embedded software development is done writing textual source code. Another paradigm exists, known as flow-based programming, in which function blocks are visually connected to compose the software design.<br>
<img src="doc/picture1-flowbased-programming.png" alt="fbp J.P. Morrisson"></p>
<p class="has-line-data" data-line-start="4" data-line-end="5">This approach is more intuitive, and facilitates IP demonstration and maintenance.</p>
<p class="has-line-data" data-line-start="6" data-line-end="7">n-Blocks Studio is a development tool to produce embedded software using the flow-based approach. It is mainly focused on developing firmware to run in the CPU-powered n-Blocks, enabling fast intuitive application development for the Internet-of-Things. Furthermore, it was developed having in mind the compatibility with other scenarios as well, becoming a general purpose embedded firmware development tool.</p>
<p class="has-line-data" data-line-start="8" data-line-end="9">Due to the flow-based strategy, users are able to develop a full working application with a lower amount of code writing as compared to conventional source code, as a large part of the writing effort is replaced by graphical connections. In several cases it is even possible to develop a full application without any code writing at all.</p>
<p class="has-line-data" data-line-start="10" data-line-end="11">Two counterparts were developed as part of n-Blocks Studio:</p>
<ul>
<li class="has-line-data" data-line-start="12" data-line-end="14">
<p class="has-line-data" data-line-start="12" data-line-end="13">Embedded code - comprising two parts: the kernel and the nodes. The kernel is a scheduler system written as embedded code, running inside the target processor, and is responsible for running the tasks required to implement the flow based approach at run time. The nodes are also embedded source code, having a predefined interface accessible by the kernel;</p>
</li>
<li class="has-line-data" data-line-start="14" data-line-end="16">
<p class="has-line-data" data-line-start="14" data-line-end="15">The editor, which is responsible for producing firmware source code using the kernel and nodes, written automatically based in a graphical diagram.</p>
</li>
</ul>
<h2 class="code-line" data-line-start=16 data-line-end=17><a id="Colaborative_model_16"></a>Colaborative model</h2>
<p class="has-line-data" data-line-start="17" data-line-end="18">A collaborative model was considered, in which users have an account in a server backend, are able to develop their own nodes, and upload to the system using their accounts. This allows the expansion of the tool capabilities in a similar fashion as libraries in systems like Arduino or mbed.</p>
<h1 class="code-line" data-line-start=19 data-line-end=20><a id="nBlocksStudio_Implemetation_Iterations_19"></a>nBlocksStudio: Implemetation Iterations</h1>
<p class="has-line-data" data-line-start="20" data-line-end="21">Four different iterations were developed as the project evolved:</p>
<h2 class="code-line" data-line-start=22 data-line-end=23><a id="Iteration_1_22"></a>Iteration 1</h2>
<p class="has-line-data" data-line-start="23" data-line-end="25">the first version, called n-Workbench, was based on the open source code base of Node RED and Audio System Design Tool for Teensy Audio Library. It was a web interface running in a browser, using JavaScript as the main technology. Being a browser page imposed limitations, such as being unable to interact with the user file system, requiring the user to copy the text, paste in a file, and compile the firmware project manually.<br>
<img src="doc/n-workbench-01.jpg" alt="n-Workbench"></p>
<h2 class="code-line" data-line-start=27 data-line-end=28><a id="Iteration_2_27"></a>Iteration 2</h2>
<p class="has-line-data" data-line-start="28" data-line-end="29">in order to allow automatic project export and compilation from inside the software, a new version was developed from scratch using python and the 3D graphics library Panda3D. A complete solution was developed, called n-Blocks Studio 1.0, including a graphical environment as well as a server backend, to support the collaborative model. This version fulfilled the full development workflow from project creation to firmware compilation, all from the same graphical interface. It also allowed collaborative node creation, but the process was cumbersome and not developer-friendly, requiring node developers to manually paste code in their account panels in the online server backend interface. Also - and most importantly - this system did not implement any form of version control, which means node developers could not update their nodes without affecting all users.</p>
<h2 class="code-line" data-line-start=30 data-line-end=31><a id="Iteration_3_30"></a>Iteration 3</h2>
<p class="has-line-data" data-line-start="31" data-line-end="32">the node creation process was reviewed and a new subsystem was developed, using the Git version control technology to keep track of node version. The n-Blocks Studio firmware generation process was reworked allowing it to fetch firmware code from Git repositories and building dependency trees, prior to embedded compilation. Node developers would then maintain their node code in repositories having all normal features provided by the Git technology and specifying the Git repository address as reference for the node, instead of placing the code itself in the server backend.</p>
<h2 class="code-line" data-line-start=33 data-line-end=34><a id="Iteration_4_33"></a>Iteration 4</h2>
<p class="has-line-data" data-line-start="34" data-line-end="36">the Panda3D graphical library, although fully functional, proved to be of difficult installation for users, and forcing inconvenient development decisions (such as preventing the split of python code into modules), causing the code to be difficult to maintain in the future as the project matures. Therefore, a new version was developed, named n-Blocks Studio 2.0, separating the graphical interface from the code generation subsystem, and a command line interface was added. This allows the tool to be used with several options of design tool, including both graphical interfaces and text files. A new design language was created, called n-Blocks Studio ASCII Notation, allowing designs to be described using any text editor by typing intuitive text symbols, which are used to generate firmware just as the graphical interface.<br>
<img src="doc/ascii-notation-02.JPG" alt="diagram"> <img src="doc/ascii-notation-01.JPG" alt="ASCII notation"></p>
<h1 class="code-line" data-line-start=39 data-line-end=40><a id="nBlocksStudio_How_it_works_39"></a>nBlocksStudio: How it works</h1>
<h2 class="code-line" data-line-start=40 data-line-end=41><a id="NODE_40"></a>NODE</h2>
<p class="has-line-data" data-line-start="41" data-line-end="44">There is a set of predefined NODEs.<br>
<img src="doc/node-01.JPG" alt="nBlocksStudio NODE"><br>
Each node has a <strong>node_name</strong>, a set of <strong>Inputs</strong> and <strong>Outputs</strong> and two files that contain c++ code: <code>node_name.cpp</code> and <code>node_name.h</code>, that define NODE functionality.</p>
<p class="has-line-data" data-line-start="46" data-line-end="47">There is a third ‘file’ with detailed information on the NODE. The NODE metadata:</p>
<ul>
<li class="has-line-data" data-line-start="47" data-line-end="48">Exact number and names of <strong>inputs</strong> and <strong>outputs</strong></li>
<li class="has-line-data" data-line-start="48" data-line-end="49">NODE-category</li>
<li class="has-line-data" data-line-start="49" data-line-end="50">Exact names of the code(.cpp) and header(.h) files</li>
<li class="has-line-data" data-line-start="50" data-line-end="52"><strong>URL</strong> of the git repository</li>
</ul>
<p class="has-line-data" data-line-start="52" data-line-end="53">The <strong>NODE metadata</strong> are stored at nBlocksStudio SERVER</p>
<h2 class="code-line" data-line-start=55 data-line-end=56><a id="maincpp_55"></a>main.cpp</h2>
<p class="has-line-data" data-line-start="56" data-line-end="61">The goal with nBlocksStudio is to create a working program inside a microcontroller.<br>
The program consists of nodes and connections. In nblocksStudio we create the program with a <strong>Diagram</strong>.<br>
<img src="doc/Diagram-01.JPG" alt="nBlocksStudio Diagram"><br>
The overall program behavior in nBlocksStudio is defined in the program’s main.cpp file.<br>
<strong>The main.cpp is created directly from the diagram and contains the NODES and their CONNECTIONS in c++ syntax.</strong></p>
<pre><code class="has-line-data" data-line-start="64" data-line-end="105">/* ================================================================ *
 *       Automatically generated by n-Blocks Studio Writer          *
 *                                                                  *
 *                         www.n-blocks.net                         *
 * ================================================================ */
#include &quot;nlib\nblocks.h&quot;
// Custom nodes:
#include &quot;nlib\Ticker\Ticker.h&quot;
#include &quot;nlib\StringPack\StringPack.h&quot;
#include &quot;nlib\SimpleSerial\SimpleSerial.h&quot;
#include &quot;nlib\INA219\ina219.h&quot;
#include &quot;nlib\LM75\lm75.h&quot;

// -*-*- List of node objects -*-*-
nBlock_INA219            nb_nBlockNode0_INA219       (P0_7, P0_30, 90, 0.1); //(PB_11, PB_10, 90, 0.1);
nBlock_StringPack        nb_nBlockNode1_StringPack   (&quot;Value: %d\n&quot;);
nBlock_SimpleSerial      nb_nBlockNode2_SimpleSerial (USBTX, USBRX);
nBlock_SimpleSerial      nb_nBlockNode3_SimpleSerial (USBTX, USBRX);
nBlock_StringPack        nb_nBlockNode4_StringPack   (&quot;Value: %d\n&quot;);
nBlock_Ticker            nb_nBlockNode5_Ticker       (1000);
nBlock_LM75              nb_nBlockNode6_LM75         (P0_7, P0_30, 90, 75.0, 80.0, 0, 1);  //(PB_11, PB_10, 90, 75.0, 80.0, 0, 1);

// -*-*- List of connection objects -*-*-
nBlockConnection    n_conn0( &amp;nb_nBlockNode6_LM75,         0,    &amp;nb_nBlockNode1_StringPack,   0);
nBlockConnection    n_conn1( &amp;nb_nBlockNode5_Ticker,       0,    &amp;nb_nBlockNode0_INA219,       0);
nBlockConnection    n_conn2( &amp;nb_nBlockNode5_Ticker,       0,    &amp;nb_nBlockNode6_LM75,         0);
nBlockConnection    n_conn3( &amp;nb_nBlockNode0_INA219,       0,    &amp;nb_nBlockNode4_StringPack,   0);
nBlockConnection    n_conn4( &amp;nb_nBlockNode1_StringPack,   0,    &amp;nb_nBlockNode2_SimpleSerial, 0);
nBlockConnection    n_conn5( &amp;nb_nBlockNode4_StringPack,   0,    &amp;nb_nBlockNode3_SimpleSerial, 0);


// -*-*- Main function -*-*-
int main(void) {
    SetupWorkbench();
    while(1) {
        ProgressNodes();
        
        // Your custom code here!
    }
}
</code></pre>
<p class="has-line-data" data-line-start="105" data-line-end="106"><strong>main.cpp</strong> except the NODES and their CONNECTIONS also contains an endless loop that runs the NODE’s code in a stepped manner.</p>
<h2 class="code-line" data-line-start=107 data-line-end=108><a id="System_Tick_107"></a>System Tick</h2>
<p class="has-line-data" data-line-start="108" data-line-end="109">in nBlocksStudio there is a 1ms <strong>Tick</strong>, which is used for the stepped exexution of code</p>
<h2 class="code-line" data-line-start=110 data-line-end=111><a id="FRAME_110"></a>FRAME</h2>
<p class="has-line-data" data-line-start="111" data-line-end="116"><strong>In Every Tick</strong> All NODEs receive messages and as an output create messages or actions.<br>
The <strong>proccessConnections function</strong> is called [for every node sequentially] and moves-in all the waiting messages.<br>
Then the <strong>stepNodes function</strong> is called [for every node sequentially] and produce output messages that wait the next tick to be moved to their receiver NODE.<br>
The overall scanning off all nodes connections and code, Periodically (in every Tick), is called <strong>FRAME</strong><br>
A FRAME is executed in 1ms period. If the overall execution time for all nodes in a FRAME is above 1ms, the next FRAME is executed immediatelly</p>
<p class="has-line-data" data-line-start="118" data-line-end="120"><img src="doc/node-execution-01.JPG" alt="nBlocksStudio node-execution"><br>
<img src="doc/frame-execution-01.JPG" alt="nBlocksStudio frame-execution"></p>
<h2 class="code-line" data-line-start=122 data-line-end=123><a id="KERNEL_122"></a>KERNEL</h2>
<p class="has-line-data" data-line-start="123" data-line-end="128">The execution of the c++ functions (proccessConnections, stepNodes…) that create the FRAMES in a timmely manner, is managed by the nBlocksStudio Kernel.<br>
The c++ classes that control the stepped execution of nodes code, are part of the nblockStudio Kernel.<br>
The Kernel code consists of the files <code>nworkbench.cpp</code> , <code>nworkbench.h</code>, <code>nBlocks.h</code>, <code>fifo.cpp</code>, <code>fifo.h</code><br>
…<br>
…</p>
<h2 class="code-line" data-line-start=129 data-line-end=130><a id="nBlocksStudio_project_folder_structure_129"></a>nBlocksStudio project folder structure.</h2>
<ul>
<li class="has-line-data" data-line-start="130" data-line-end="131">simple and small project tree</li>
<li class="has-line-data" data-line-start="131" data-line-end="132">about mbed dependencies</li>
<li class="has-line-data" data-line-start="132" data-line-end="138">project_name
<ul>
<li class="has-line-data" data-line-start="133" data-line-end="134">nLib</li>
<li class="has-line-data" data-line-start="134" data-line-end="135">main.cpp</li>
<li class="has-line-data" data-line-start="135" data-line-end="138">build<br>
<img src="doc/project_tree.JPG" alt="nBlocksStudio project_tree"></li>
</ul>
</li>
</ul>
<h2 class="code-line" data-line-start=138 data-line-end=139><a id="nLib_138"></a>nLib</h2>
<ul>
<li class="has-line-data" data-line-start="139" data-line-end="140">Code folders of NODEs that are used in the project</li>
<li class="has-line-data" data-line-start="140" data-line-end="142">Five(5) Kernel files<br>
<img src="doc/nLib_folder.JPG" alt="nBlocksStudio nLib_folder"></li>
</ul>
<h2 class="code-line" data-line-start=144 data-line-end=145><a id="mbed_Dependencies_144"></a>mbed Dependencies</h2>
</body></html>